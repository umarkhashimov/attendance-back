{% extends 'layout/base.html' %}
{% load math_extras %}
{% block title %}
    <title>Панель Управления</title>
{% endblock %}
{% block content %}
    {% include 'layout/navbar.html' %}

    <div class="container pt-1">
        <div class="mt-4 mb-2 d-flex align-items-center justify-content-between">
            <h5 class="mt-1 mb-2">Зарплата за группу</h5>
        </div>
        <hr class="table-group-divider"/>
        <div class="row m-0 p-0 ">
            <div class="col-12 bg-light rounded pt-2 px-2 border">
                <form id="filterForm" method="get" class=""
                      onreset="resetForm(event)">
                    <div class="">
                        <h6 class="text-dark  ms-1 fs-6 m-0">Фильтры
                            <button type="reset" class="filter-reset-btn ms-2 mb-1"><p>Очистить</p></button>
                        </h6>
                    </div>
                    <div class="row mt-2 pb-3">
                        <div class="col-12 col-md-2">
                            <div class="custom-select-2">
                                <label for="daySelect" class="me-2 ms-1 mb-1">{{ filter_form.month.label }}</label>
                                {{ filter_form.month }}
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="col-12 bg-light rounded pt-2 px-2 border my-3">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">Учитель: <b>{{ teacher }}</b></li>
                    <li class="list-group-item">Цена Курса (12 занятий): <b>{{ course.session_cost }}</b></li>
                    <li class="list-group-item">Цена Курса (1 занятия):
                        <b>{{ course.session_cost|div:12|floatformat:2 }}</b></li>
                    <li class="list-group-item">
                        <div class="row">
                            <div class="col-5">

                            <div class="input-group mb-3 border-1 border-dark-subtle border">

                                <label for="priceForAll" class="input-group-text" id="basic-addon1">Цена за всех</label>
                                <input oninput="priceInputChange(this)" onblur="priceInpBlur(this)" type="number" class="form-control" placeholder="..." aria-label="Username"
                                       aria-describedby="basic-addon1" id="priceForAll">
                                <button class="btn btn-success rounded-0" onclick="assignAllPrice()"><i class="bi bi-check-lg"></i></button>
                            </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-bordered w-100 attendance-record-table table-hover">
                <thead class="sticky-top">
                <tr>
                    <td class="p-0 text-center border border-1 border-secondary">Цена</td>
                    <td class="p-0 text-center border border-1 border-secondary">Имя студента</td>
                    {% for session in sessions %}
                        <td data-bs-toggle="tooltip" data-bs-placement="top"
                                {% if session.record_by.id != session.course.teacher.id %}
                            title="Урок не был отмечен учителем: {{ session.record_by|default:'Бот' }}"  {% elif session.status == False %}
                            title="Урок отменен" {% else %} title="Отметил: {{ session.record_by|default:'Бот' }}" {% endif %}  onclick="checkWholeColumn({{ forloop.counter }})"
                            col="{{ forloop.counter }}"
                            class="px-0 text-center cursor-pointer border border-secondary border-1 date-cell {% if session.record_by.id != session.course.teacher.id %} bg-secondary-subtle  {% elif session.status == False %} bg-danger-subtle {% endif %}">
                            <span>{{ session.date|date:"d" }}</span>
                        </td>
                    {% endfor %}
                </tr>
                </thead>
                <tbody>
                {% for record in attendance_data %}
                    <tr class="info_row" row="{{ forloop.counter }}">
                        <td class="p-0 border-secondary-subtle status-cell max-w-130px min-w-100px align-middle">
                            <div class="d-flex justify-content-center w-100">
                                <input id="priceInput" value="{{ record.price_for_student|stringformat:'s' }}"
                                       oninput="priceInputChange(this)"
                                       onblur="priceInpBlur(this)"
                                       type="number" maxlength="4"
                                       class="form-control rounded-0 border-none shadow-none border-0 w-100 text-center min-w-100px">
                            </div>
                        </td>
                        <td class="p-2 min-w-130px border border-secondary-subtle status-cell text-break text-wrap"><a
                                href="{% url 'students:student_update' pk=record.student.id %}"
                                class="text-decoration-none text-dark table-obj-name-link"><span
                                data-bs-toggle="tooltip" data-bs-placement="top" title="Скидка" role='button'
                                class="text-secondary mx-1">{{ record.enrollment.discount }}% </span>{{ record.student.full_name }}
                        </a> {% if record.enrollment.transferred %}
                            <span data-bs-toggle="tooltip" data-bs-placement="top" title="Перенаправленная запись"
                                  role='button' class="text-primary ms-1"><i class="bi bi-exclamation-circle-fill"></i></span>{% endif %}
                            <span data-bs-toggle="tooltip" data-bs-placement="top" title="Баланс"
                                  class="text-success {% if record.balance <= 0 %}text-danger{% elif record.balance == None %}text-secondary{% endif %}"> | {{ record.balance|default:'--' }}</span>
                        </td>
                        {% for info in record.attendance %}
                            <td col="{{ forloop.counter }}"
                                class=" p-0 border align-middle {% if info.trial_attendance == True %} border-warning border-4 {% else %} border-secondary-subtle {% endif %}  text-center status-cell {% if info.status == 1 %} bg-success bg-opacity-75 {% elif info.status == 0 %} bg-danger bg-opacity-75 {% elif info.status == 2 %} bg-warning bg-opacity-50 {% elif info.status == 3 %} bg-info bg-opacity-50  {% elif info.status is None %} bg-secondary bg-opacity-50 {% endif %}">
                                {% if info.status|stringformat:'s' in '1.2.0' or info.status == None %}
                                    <label for="salaryCheckbox-{{ record.student.id }}-{{ forloop.counter }}"
                                           class="position-relative text-black w-100 h-100 cursor-pointer">
                                        {% if info.session.status == True and info.trial_attendance == False and info.payed == True and not info.absent_trial %}
                                            <input col="{{ forloop.counter }}"
                                                   {% if info.status != None and info.session.record_by.id == info.session.course.teacher.id %}checked{% endif %}
                                                   type="checkbox"
                                                   class="shadow-none border-1 border-black fs-3 attendance-checkbox salary-checkbox"
                                                   id="salaryCheckbox-{{ record.student.id }}-{{ forloop.counter }}">
                                            <span class="checkmark"></span>
                                        {% endif %}
                                    </label>
                                {% endif %}
                            </td>

                        {% endfor %}
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="{{ sessions|length|add:1 }}" class="text-center">Нет записей</td>
                    </tr>
                {% endfor %}
                </tbody>


            </table>
        </div>
        <div>
            <h5 id="priceWindow">
                <p id="quantity" class="fs-6 fw-normal">Кол-во: <span>--</span></p>
                <p id="price">Обшая сумма: <span>--</span></p>
            </h5>
            <button class="btn btn-primary" onclick="FindAllCheckedBoxes()">Подсчитать</button>
        </div>
    </div>
{% endblock %}

{% block custom_js %}
    <script>

        function assignAllPrice(){
            let allPrice = document.getElementById('priceForAll').value
            allPrice = allPrice ? allPrice : 0
            const priceInputs = document.querySelectorAll('#priceInput')
            priceInputs.forEach((inp) => {
                inp.value = allPrice
            })
        }

        function priceInputChange(e) {
            const oldValue = e.value;
            const caretPosition = e.selectionStart;

            // Match only allowed pattern: digits and max one dot
            const validPattern = /^(\d+(\.\d*)?|\.\d*)?$/;

            if (!validPattern.test(oldValue)) {
                // Remove all invalid characters and multiple dots
                let newValue = oldValue.replace(/[^0-9.]/g, '');

                // Keep only the first dot
                const firstDot = newValue.indexOf('.');
                if (firstDot !== -1) {
                    newValue = newValue.substring(0, firstDot + 1) + newValue.substring(firstDot + 1).replace(/\./g, '');
                }

                // Update value and restore caret
                e.value = newValue;
                e.setSelectionRange(caretPosition - 1, caretPosition - 1);
            }
        }

        function priceInpBlur(e) {
            let value = e.value.trim();

            // Empty or just a dot becomes 0.00
            if (value === '' || value === '.') {
                e.value = '0.00';
                return;
            }

            // If starts with a dot, prefix with 0
            if (value.startsWith('.')) {
                value = '0' + value;
            }

            // Format to float with 2 decimal places
            const num = parseFloat(value);
            if (!isNaN(num)) {
                e.value = num.toFixed(2);
            } else {
                e.value = '0.00';
            }
        }


        function FindAllCheckedBoxes() {
            let overall = 0
            const infoRows = document.querySelectorAll('tr.info_row')

            infoRows.forEach((row) => {
                const price = row.querySelector('#priceInput').value
                const checkedCount = row.querySelectorAll('input[type="checkbox"].attendance-checkbox:checked').length
                let rowPrice = parseFloat(price) * Number(checkedCount)
                overall = overall + rowPrice
            })
            const priceWindow = document.getElementById("priceWindow")
            priceWindow.querySelector('#price > span').innerHTML = overall.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            priceWindow.querySelector('#quantity > span').innerHTML = document.querySelectorAll('input[type="checkbox"].attendance-checkbox:checked').length
        }

        function checkWholeColumn(col) {
            const checkBoxesCol = document.querySelectorAll(`input[type="checkbox"].attendance-checkbox[col="${col}"]`)
            const checkedBoxesCol = document.querySelectorAll(`input[type="checkbox"].attendance-checkbox[col="${col}"]:checked`)

            let status = true;
            if (checkBoxesCol.length === checkedBoxesCol.length){
                status = false
            }
            checkBoxesCol.forEach((box) => {
                box.checked = status
            })
        }
    </script>
{% endblock %}
