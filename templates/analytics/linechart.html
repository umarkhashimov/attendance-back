{% extends 'layout/base.html' %}

{% block custom_css %}

    <style>
        .wrap {
            max-width: 1100px;
            margin: 24px auto;
            padding: 16px
        }

        .toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 12px
        }

        .toolbar select, .toolbar input, .toolbar button {
            padding: 6px 8px
        }
    </style>

{% endblock %}
{% block content %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% include 'layout/navbar.html' %}

    <div class="container courses-list">
        <div class="mt-4 mb-2">
            <h5 class="m-0">Линейная Графа</h5>
        </div>
        <hr class="table-group-divider"/>
        <div class="row m-0 p-0 ">
            <div class="col-12 bg-light rounded py-2 px-2 border">
                <form id="filterForm" method="get" onsubmit="requestData(event)"
                      action="{% url 'analytics:analytics_page' %}" class="noBtn"
                      onreset="resetForm(event)">
                    <div class="">
                        <h6 class="text-dark ms-1 fs-6 m-0">Фильтры
                            <button type="reset" class="filter-reset-btn ms-2 mb-1"><p>Очистить</p></button>
                        </h6>
                    </div>
                    <div class="row mt-2 pb-2">
                        <div class="col-12 col-md-4">
                            <div class="custom-select-2">
                                <label for="subject" class="me-2 ms-1 mb-1">{{ filter_form.date_from.label }}</label>
                                {{ filter_form.date_from }}
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="custom-select-2">
                                <label for="subject" class="me-2 ms-1 mb-1">{{ filter_form.date_to.label }}</label>
                                {{ filter_form.date_to }}
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="custom-select-2">
                                <label for="subject" class="me-2 ms-1 mb-1">{{ filter_form.show.label }}</label>
                                {{ filter_form.show }}
                            </div>
                        </div>

                    </div>
                </form>
            </div>
        </div>

        <div class="row m-0 p-0 py-3">
            <div class="col-12 py-4">
                <canvas id="chart" height="120"></canvas>
            </div>
        </div>
    </div>

    <script>
        function getUrlParams() {
            return Object.fromEntries(new URLSearchParams(window.location.search));
        }

        function setUrlParam(key, value) {
            const url = new URL(window.location);
            url.searchParams.set(key, value);
            window.history.replaceState({}, '', url);
        }

        const requestURL = new URL("{% url 'analytics:analytics_series_json' %}", window.location.origin);

        function getCookie(name) {
            const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return m ? m.pop() : '';
        }

        async function requestAnalytics() {
            const params = getUrlParams()

            const response = await fetch(requestURL, {
                method: "POST",
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify(params),
            });
            const result = await response.json();

            const labels = result.labels;
            const series = result.series;
            const verbose = result.verbose || {};

            const datasets = Object.keys(series).map((key) => ({
                label: verbose[key] || key,   // ← show verbose name
                data: series[key],
                metaKey: key,                 // ← keep original field name for tooltip logic
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 2,
                fill: false
            }));

            drawChart(labels, datasets)
        }

        window.onload = requestAnalytics();

        async function requestData(event) {

            event.preventDefault();
            const form = event.target
            let formData = new FormData(event.target);
            const params = Object.fromEntries(formData);

            for (let k in params) {
                setUrlParam(k, params[k])
            }

            await requestAnalytics()
        }


        const ctx = document.getElementById('chart');
        const moneyFmt = new Intl.NumberFormat('uz-UZ', {style: 'currency', currency: 'UZS', maximumFractionDigits: 0});
        const numFmt = new Intl.NumberFormat('uz-UZ');

        function drawChart(labels, dataset) {
            const existing = Chart.getChart(ctx);   // ✅ find chart bound to this canvas
            if (existing) existing.destroy();

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [...labels],
                    datasets: [...dataset],
                },
                options: {
                    responsive: true,
                    interaction: {mode: 'index', intersect: false},
                    plugins: {
                        legend: {display: true},
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const v = ctx.parsed.y ?? 0;
                                    return ctx.dataset.metaKey == 'payments_sum'
                                        ? moneyFmt.format(v)
                                        : numFmt.format(v);
                                }
                            }
                        }
                    },
                    scales: {y: {beginAtZero: true}}
                }
            })
        }

    </script>

{% endblock %}

