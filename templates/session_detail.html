{% extends 'layout/base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block title %}
<title>Курс</title>
{% endblock %}

{% block content %}
{% include 'layout/navbar.html' %}

<div class="container courses-list mt-5 pb-5">
  <div class="row">
    {% comment %} {% if user.role == '2' and session %}
    <div class="d-flex mb-5">
      <div class="col-12 d-flex gap-3">
        <form method="get" action="{% url "attendance:session_date" course_id=session.course.id %}" id="customDateForm"
          value='{{session.date}}' class="h-100">
          <input type="date" name="date" class="h-100 border-1 border-primary text-center rounded-2"
            value="{{session.date|date:'Y-m-d'}}" id="customDatePicker">
        </form>

        {% if prev_session %}
        <a class="btn btn-outline-primary" href=""><i
            class="bi bi-arrow-bar-left me-2"></i>Урок {{prev_session.session_number}}</a>
        {% endif %}
        {% if next_session %}
        <a class="btn btn-outline-primary" href="">Урок
          {{next_session.session_number}}<i class="bi bi-arrow-bar-right ms-2"></i></a>
        {% endif %}
      </div>
    </div>
    {% endif %} {% endcomment %}

    {% if session %}
    <h2 class="mt-3"> Урок {{ session.date }} - {{ session.course.lesson_time|time:'H:i'}}</h2>
    {% else %}
    <h2 class="mt-3"> Урок {{ today }} - {{ course.lesson_time|time:'H:i'}}</h2>
    {% endif %}
    <hr class="table-group-divider" />

    {% if session %}
    
    {% if session.status %}
    {% comment %} <div class="markAllBtn mb-2">
      <button onclick="checkAll()">Отметить все <i class="bi bi-check-lg"></i></button>
      <button onclick="uncheckAll()">Отметить все <i class="bi bi-x-lg"></i></i></button>
    </div> {% endcomment %}
    
    <form method="post" action="{% url 'attendance:session_detail' course_id=session.course.id session_id=session.id %}">
      {% csrf_token %}
      <input type="number" name="session_id" hidden value="{{ session.id }}">
      <table class="table border students-attendance-list">
        <tbody>
          {% for obj in attendance %}
          <tr class="attendance-item" status='{% if obj.status == True %}present{% elif obj.status == False %}absent{% else %}{% endif %}' stid="{{obj.enrollment.student.student_id}}" class="attendance-item absent">
            <td class="w-100 align-middle ps-3 name">{{obj.enrollment.student.first_name}} {{obj.enrollment.student.last_name}} {{obj.status}}
              <span class="ms-3">
                {% if obj.enrollment.hold >= 1 %}<span title="Заморожен {{obj.enrollment.hold}} " role='button' class="text-primary"><i class="bi bi-exclamation-circle-fill"></i></span>{% endif %}
                {% if obj.enrollment.balance <= 0 %}<span title="Долг {{obj.enrollment.balance}} " role='button' class="text-danger"><i class="bi bi-exclamation-circle-fill"></i></span>{% endif %}
              </span>
            </td>
            <td class="d-flex justify-content-end text-end">
              <input hidden class="studentStatusInput" type="text" name="stid_{{obj.enrollment.student.student_id}}" value="{% if obj.status == True %}present{% elif obj.status == False %}absent{% else %}{% endif %}">
              <div class="gradesInp d-flex gap-2 me-2">
                <input type="number" name="ga_{{obj.enrollment.student.student_id}}" value="{{obj.participation_grade}}" class="form-control grade-inp border-2" title="Оценка за посещаемость">
                <input type="number" name="ghw_{{obj.enrollment.student.student_id}}" value="{{obj.homework_grade}}" class="form-control grade-inp border-2" title="Оценка за домашнее задание">
              </div>
              <div class="d-flex marked-conf">
                <div class="d-flex align-items-center h-100 mx-2 marked-status-badge">
                  <p class="badge present text-bg-success rounded-5 m-0 my-auto"><i class="bi bi-check"></i></p>
                  <p class="badge absent text-bg-danger rounded-5 m-0 my-auto"><i class="bi bi-x"></i></p>
                </div>
                <button type="button" onclick="unmarkStudent({{obj.enrollment.student.student_id}})" class="btn btn-light border border-dark px-2"><i class="bi bi-pencil-fill"></i></button>
              </div>
              <div class="btn-group gap-1 choose check-buttons">
                <button type="button" onclick="markStudent('absent', {{obj.enrollment.student.student_id}})" class="btn btn-danger px-3"><i class="bi bi-x-lg"></i></button>
                <button type="button" onclick="markStudent('present', {{obj.enrollment.student.student_id}})" class="btn btn-success px-3"><i class="bi bi-check-lg"></i></button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary py-2">Сохранить</button>
      </div>
    </form>

    {% else %}
   
    <div class="alert alert-danger" role="alert">
      <h5 class="m-0">Урок отменен!</h5>
    </div>
    {% endif %}
    {% else %}
    <div class="border p-3 border-3 d-flex align-items-center justify-content-between rounded-3">
      <h5 class="m-0">Урок проведен?</h5>
      <div>
        <button type="button" class="btn btn-danger px-4" data-bs-toggle="modal" data-bs-target="#exampleModal">
          <i class="bi bi-x-lg"></i>
        </button>
        <a href="{% url "courses:conduct_session" course_id=course.id %}" class="btn btn-success px-4"><i
          class="bi bi-check-lg"></i></a>
          <!-- cancel session modal -->
          <!-- Button trigger modal -->
          
          <div data-bs-backdrop="static" class="modal fade" id="exampleModal" tabindex="-1"
          aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form action="{% url "courses:cancel_session" course_id=course.id %}" method='post'>
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Отмена урока</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
                {% csrf_token %}
                <div class="modal-body">
                  {{cancel_cause_form|crispy}}
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Сохранить</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% if messages %}
  {% for message in messages %}
  {% if message.tags == 'error' %}
  <div class="alert alert-danger my-3" role="alert">{{message}}</div>
  {% endif %}
  {% endfor %}
    {% endif %}
  </div>
  {% endblock %}

  {% block custom_js %}
  <script>
    {% comment %} {% if user.role == '2' %}
    document.getElementById('customDatePicker').addEventListener('change', () => {
      document.getElementById('customDateForm').submit()
    })
    let dates = JSON.parse('{{all_session_dates|safe}}')
    flatpickr("#customDatePicker", {
      dateFormat: "Y-m-d",
      enable: dates,

    });
    {% endif %} {% endcomment %}

    window.onload = () => {
      checkInputs = document.querySelectorAll('input.checkStatus')

      document.querySelectorAll('input[type="number"].grade-inp').forEach((inp) => {
        inp.addEventListener('input', () => {
        // Ensure the input value is a number
        let value = inp.value;

        // If the value is not a number or is outside the range of 0 to 5, reset it to an empty string or limit it.
        if (isNaN(value) || value < 0 || value > 5) {
          inp.value = ''; // Clear the input if the value is invalid
        } else {
          // Optionally, if you want to ensure only valid values are shown, limit the decimal places or sanitize input here
          inp.value = value; // Set back the valid value
        }
      });
      })

      document.querySelectorAll('input[type="checkbox"].checkStatus').forEach((inp) => {
        inp.addEventListener('change', () => {
          let gradeDiv = document.querySelector(`div#${inp.getAttribute("gradeFor")}`)
          console.log(inp.checked, gradeDiv);
          if (inp.checked) {
            gradeDiv.classList.remove('hiddenDiv')
          }else{
            gradeDiv.classList.add('hiddenDiv')
          }
        })
      })
    }

    function uncheckAll() {
      checkInputs.forEach((inp) => {
        inp.checked = false;
        inp.dispatchEvent(new Event('change'))
      })
    }

    function checkAll() {
      checkInputs.forEach((inp) => {
        inp.checked = true
        inp.dispatchEvent(new Event('change'))
      })
    }
  </script>
  <script src="{% static 'js/attendance.js' %}"></script>
  {% endblock %}